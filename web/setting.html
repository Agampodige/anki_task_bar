<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Settings</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="qrc:///qtwebchannel/qwebchannel.js"></script>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="setting.css">
</head>

<body>
    <div class="page-header">
        <div style="display: flex; align-items: center; gap: 10px;">
            <a href="index.html" class="btn secondary" style="padding: 6px 12px;">← Back</a>
            <h1>Settings</h1>
        </div>
        <div id="settings-status" class="settings-status" aria-live="polite"></div>
    </div>

    <main id="settings-main" class="settings-container">
        <div class="setting-card">
            <div class="setting-info">
                <span class="setting-label">Hide Completed Decks</span>
                <span class="setting-desc">Hide the completed section on the home page.</span>
            </div>
            <label class="switch">
                <input type="checkbox" id="hideDecksToggle">
                <span class="slider"></span>
            </label>
        </div>

        <div class="setting-card">
            <div class="setting-info">
                <span class="setting-label">Auto Hide on Review</span>
                <span class="setting-desc">Automatically hide the widget when you start reviewing a deck.</span>
            </div>
            <label class="switch">
                <input type="checkbox" id="sessionToggle">
                <span class="slider"></span>
            </label>
        </div>

        <div class="setting-card">
            <div class="setting-info">
                <span class="setting-label">Enable Sessions</span>
                <span class="setting-desc">Create and activate saved groups of decks.</span>
            </div>
            <label class="switch">
                <input type="checkbox" id="sessionsEnabledToggle">
                <span class="slider"></span>
            </label>
        </div>

        <div class="setting-card">
            <div class="setting-info">
                <span class="setting-label">Show Statistics Bar</span>
                <span class="setting-desc">Display selected decks statistics at the top of the home page.</span>
            </div>
            <label class="switch">
                <input type="checkbox" id="showStatsBarToggle">
                <span class="slider"></span>
            </label>
        </div>

        <div class="setting-card">
            <div class="setting-info">
                <span class="setting-label">Hide Search Bar</span>
                <span class="setting-desc">Remove the search input from the home page.</span>
            </div>
            <label class="switch">
                <input type="checkbox" id="hideSearchBarToggle">
                <span class="slider"></span>
            </label>
        </div>

        <div class="setting-card">
            <div class="setting-info">
                <span class="setting-label">Zoom Level</span>
                <span class="setting-desc">Adjust interface size. (Ctrl+Scroll disabled)</span>
            </div>
            <div class="zoom-controls" style="display: flex; align-items: center; gap: 10px;">
                <button id="zoom-out" class="icon-btn-tiny"
                    style="width: 30px; height: 30px; border: 1px solid var(--border-color);">-</button>
                <span id="zoom-value" style="font-weight: bold; min-width: 40px; text-align: center;">100%</span>
                <button id="zoom-in" class="icon-btn-tiny"
                    style="width: 30px; height: 30px; border: 1px solid var(--border-color);">+</button>
            </div>
        </div>

        <hr class="divider">
        <h3 style="margin: 10px 0; font-size: 1rem; color: var(--text-secondary);">Appearance</h3>

        <div class="setting-card" style="flex-direction: column; align-items: flex-start; gap: 10px;">
            <div class="setting-info">
                <span class="setting-label">Accent Color</span>
            </div>
            <div class="color-options">
                <button class="color-btn" data-color="green" style="background: #4CAF50;" title="Green"></button>
                <button class="color-btn" data-color="blue" style="background: #2196F3;" title="Blue"></button>
                <button class="color-btn" data-color="purple" style="background: #9C27B0;" title="Purple"></button>
                <button class="color-btn" data-color="orange" style="background: #FF9800;" title="Orange"></button>
                <button class="color-btn" data-color="pink" style="background: #E91E63;" title="Pink"></button>
                <button class="color-btn" data-color="teal" style="background: #009688;" title="Teal"></button>
            </div>
        </div>

        <div class="setting-card">
            <div class="setting-info">
                <span class="setting-label">Compact Mode</span>
                <span class="setting-desc">Denser view with smaller padding.</span>
            </div>
            <label class="switch">
                <input type="checkbox" id="compactModeToggle">
                <span class="slider"></span>
            </label>
        </div>

        <div class="setting-card">
            <div class="setting-info">
                <span class="setting-label">Confetti Effects</span>
                <span class="setting-desc">Celebrate when finding or completing tasks.</span>
            </div>
            <label class="switch">
                <input type="checkbox" id="confettiToggle">
                <span class="slider"></span>
            </label>
        </div>

        <hr class="divider">

        <button type="button" id="open-help-page" class="setting-card link-card">
            <div class="setting-label">How to Use</div>
            <span class="icon">?</span>
        </button>

        <button type="button" id="open-addon-folder" class="setting-card link-card">
            <div class="setting-label">Open Add-on Folder</div>
            <span class="icon">›</span>
        </button>

        <button type="button" id="open-project-page" class="setting-card link-card">
            <div class="setting-label">Project Page</div>
            <span class="icon">›</span>
        </button>

        <button type="button" id="export-sessions" class="setting-card link-card">
            <div class="setting-label">Export Sessions</div>
            <span class="icon">↓</span>
        </button>

        <button type="button" id="import-sessions" class="setting-card link-card">
            <div class="setting-label">Import Sessions</div>
            <span class="icon">↑</span>
        </button>
    </main>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const hideToggle = document.getElementById("hideDecksToggle");
            const sessionToggle = document.getElementById("sessionToggle");
            const sessionsEnabledToggle = document.getElementById("sessionsEnabledToggle");
            const showStatsBarToggle = document.getElementById("showStatsBarToggle");
            const hideSearchBarToggle = document.getElementById("hideSearchBarToggle");
            const compactModeToggle = document.getElementById("compactModeToggle");
            const confettiToggle = document.getElementById("confettiToggle");
            const colorBtns = document.querySelectorAll('.color-btn');

            // Zoom controls
            const zoomInBtn = document.getElementById("zoom-in");
            const zoomOutBtn = document.getElementById("zoom-out");
            const zoomValueEl = document.getElementById("zoom-value");
            let currentZoom = 1.0;

            const statusEl = document.getElementById("settings-status");
            const openAddonFolderBtn = document.getElementById("open-addon-folder");
            const openProjectBtn = document.getElementById("open-project-page");
            const openHelpBtn = document.getElementById("open-help-page");
            const openSessionsBtn = document.getElementById("open-sessions-page");
            const exportSessionsBtn = document.getElementById("export-sessions");
            const importSessionsBtn = document.getElementById("import-sessions");

            let currentSettings = {};

            function setStatus(text, kind) {
                if (!statusEl) return;
                statusEl.textContent = text || '';
                statusEl.dataset.kind = kind || '';
                if (!text) return;
                window.clearTimeout(window._settingsStatusTimer);
                window._settingsStatusTimer = window.setTimeout(() => {
                    statusEl.textContent = '';
                    statusEl.dataset.kind = '';
                }, 1500);
            }

            const defaultSettings = {
                hideCompleted: false,
                enableSessions: true,
                sessionsEnabled: true,
                showStatsBar: true,
                hideSearchBar: false,
                compactMode: false,
                confettiEnabled: true,
                theme: 'green',
                zoomLevel: 1.0
            };

            function updateZoomDisplay() {
                if (zoomValueEl) zoomValueEl.textContent = `${Math.round(currentZoom * 100)}%`;
            }

            function getSettingsFromUI() {
                // Find selected color
                const selectedBtn = document.querySelector('.color-btn.selected');
                const theme = selectedBtn ? selectedBtn.dataset.color : 'green';

                return {
                    hideCompleted: !!hideToggle?.checked,
                    enableSessions: !!sessionToggle?.checked,
                    sessionsEnabled: !!sessionsEnabledToggle?.checked,
                    showStatsBar: !!showStatsBarToggle?.checked,
                    hideSearchBar: !!hideSearchBarToggle?.checked,
                    compactMode: !!compactModeToggle?.checked,
                    confettiEnabled: !!confettiToggle?.checked,
                    theme: theme,
                    zoomLevel: currentZoom
                };
            }

            function saveAllSettings() {
                const settings = getSettingsFromUI();
                const jsonString = JSON.stringify(settings);

                // Apply immediate previews
                document.documentElement.setAttribute('data-theme', settings.theme);
                document.body.style.zoom = settings.zoomLevel;

                try {
                    localStorage.setItem('anki_task_bar_settings', jsonString);
                } catch (e) {
                }

                if (window.py && typeof window.py.save_settings_to_file === 'function') {
                    try {
                        window.py.save_settings_to_file(jsonString);
                        setStatus('Saved', 'ok');
                    } catch (e) {
                        setStatus('Error', 'error');
                        console.error('Error saving settings:', e);
                    }
                } else {
                    setStatus('Saved (local)', 'ok');
                }
            }

            function applySettingsToUI(settings) {
                const merged = { ...defaultSettings, ...(settings || {}) };
                currentSettings = merged;

                if (hideToggle) hideToggle.checked = !!merged.hideCompleted;
                if (sessionToggle) sessionToggle.checked = !!merged.enableSessions;
                if (sessionsEnabledToggle) sessionsEnabledToggle.checked = !!merged.sessionsEnabled;
                if (showStatsBarToggle) showStatsBarToggle.checked = !!merged.showStatsBar;
                if (hideSearchBarToggle) hideSearchBarToggle.checked = !!merged.hideSearchBar;
                if (compactModeToggle) compactModeToggle.checked = !!merged.compactMode;
                if (confettiToggle) confettiToggle.checked = !!merged.confettiEnabled;

                currentZoom = merged.zoomLevel !== undefined ? merged.zoomLevel : 1.0;
                updateZoomDisplay();

                // Color selection
                colorBtns.forEach(btn => {
                    if (btn.dataset.color === merged.theme) {
                        btn.classList.add('selected');
                    } else {
                        btn.classList.remove('selected');
                    }
                });

                // Apply theme/zoom to body for preview
                document.documentElement.setAttribute('data-theme', merged.theme);
                document.body.style.zoom = currentZoom;

                if (openSessionsBtn) {
                    openSessionsBtn.style.display = merged.sessionsEnabled ? 'flex' : 'none';
                }
            }

            function loadInitialSettings() {
                if (window.py && typeof window.py.load_settings_from_file === 'function') {
                    window.py.load_settings_from_file((data) => {
                        try {
                            const cfg = data ? JSON.parse(data) : {};
                            applySettingsToUI(cfg);
                        } catch (e) {
                            applySettingsToUI(defaultSettings);
                        }
                    });
                    return;
                }

                try {
                    const local = localStorage.getItem('anki_task_bar_settings');
                    applySettingsToUI(local ? JSON.parse(local) : defaultSettings);
                } catch (e) {
                    applySettingsToUI(defaultSettings);
                }
            }

            function bindUI() {
                hideToggle?.addEventListener("change", saveAllSettings);
                sessionToggle?.addEventListener("change", saveAllSettings);
                sessionsEnabledToggle?.addEventListener("change", saveAllSettings);
                showStatsBarToggle?.addEventListener("change", saveAllSettings);
                hideSearchBarToggle?.addEventListener("change", saveAllSettings);
                compactModeToggle?.addEventListener("change", saveAllSettings);
                confettiToggle?.addEventListener("change", saveAllSettings);

                // Zoom Handlers
                zoomInBtn?.addEventListener('click', () => {
                    currentZoom = Math.min(Math.round((currentZoom + 0.1) * 10) / 10, 2.0);
                    updateZoomDisplay();
                    saveAllSettings();
                });

                zoomOutBtn?.addEventListener('click', () => {
                    currentZoom = Math.max(Math.round((currentZoom - 0.1) * 10) / 10, 0.5);
                    updateZoomDisplay();
                    saveAllSettings();
                });

                colorBtns.forEach(btn => {
                    btn.addEventListener('click', () => {
                        colorBtns.forEach(b => b.classList.remove('selected'));
                        btn.classList.add('selected');
                        saveAllSettings();
                    });
                });

                openAddonFolderBtn?.addEventListener('click', () => {
                    if (window.py && typeof window.py.open_addon_folder === 'function') {
                        window.py.open_addon_folder();
                    }
                });

                openHelpBtn?.addEventListener('click', () => {
                    const url = 'https://github.com/Agampoci/anki-task-bar/blob/main/README.md'; // Fallback link
                    if (window.py && typeof window.py.open_link === 'function') {
                        window.py.open_link(url);
                    } else {
                        try { window.open(url, '_blank'); } catch (e) { }
                    }
                });

                openProjectBtn?.addEventListener('click', () => {
                    const url = 'https://github.com/Agampodige/anki_task_bar';
                    if (window.py && typeof window.py.open_link === 'function') {
                        window.py.open_link(url);
                    } else {
                        try { window.open(url, '_blank'); } catch (e) { }
                    }
                });

                openSessionsBtn?.addEventListener('click', () => {
                    window.location.href = 'sessions.html';
                });

                exportSessionsBtn?.addEventListener('click', () => {
                    if (window.py && typeof window.py.export_sessions === 'function') {
                        window.py.export_sessions((res) => {
                            try {
                                const data = JSON.parse(res);
                                if (data.ok) {
                                    setStatus('Exported to ' + data.path.split(/[\\/]/).pop(), 'ok');
                                } else if (data.error !== 'cancelled') {
                                    setStatus('Export failed', 'error');
                                }
                            } catch (e) {
                                console.error('Export error:', e);
                            }
                        });
                    }
                });

                importSessionsBtn?.addEventListener('click', () => {
                    if (window.py && typeof window.py.import_sessions === 'function') {
                        window.py.import_sessions((res) => {
                            try {
                                const data = JSON.parse(res);
                                if (data.ok) {
                                    setStatus('Imported successfully', 'ok');
                                } else if (data.error !== 'cancelled') {
                                    setStatus('Import failed: ' + data.error, 'error');
                                }
                            } catch (e) {
                                console.error('Import error:', e);
                            }
                        });
                    }
                });
            }

            bindUI();

            if (typeof QWebChannel !== 'undefined' && typeof qt !== 'undefined' && qt.webChannelTransport) {
                new QWebChannel(qt.webChannelTransport, function (channel) {
                    window.py = channel.objects.py;
                    loadInitialSettings();
                });
            } else {
                loadInitialSettings();
            }
        });
    </script>
</body>

</html>